<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактирование профиля</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .profile-container { max-width: 500px; margin: 50px auto; padding: 30px; background: #f8f9fa; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
</nav>

<div class="container">
    <div class="profile-container">
        <h2 class="text-center mb-4">Редактирование профиля</h2>

        <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>
        <div id="successAlert" class="alert alert-success" style="display: none;"></div>

        <form id="profileForm">
            <div class="mb-3">
                <label for="currentEmail" class="form-label">Текущая почта</label>
                <input type="text" class="form-control" id="currentEmail" disabled>
            </div>
            <div class="mb-3">
                <label for="newEmail" class="form-label">Новая почта</label>
                <input type="text" class="form-control" id="newEmail" placeholder="Введите новую почту">
                <div class="form-text">Оставьте пустым, если не хотите менять.</div>
            </div>
            <div class="mb-3">
                <label for="currentPassword" class="form-label">Текущий пароль</label>
                <input type="password" class="form-control" id="currentPassword"
                       placeholder="Введите текущий пароль">
                <div class="form-text">Требуется только если меняете пароль</div>
            </div>

            <div class="mb-3">
                <label for="newPassword" class="form-label">Новый пароль</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="newPassword"
                           placeholder="Введите новый пароль">
                </div>
                <div class="form-text">Минимум 8 символов</div>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">Сохранить изменения</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтвердите новую почту</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Мы отправили код на вашу новую почту. Пожалуйста, введите его ниже.</p>
                <div id="modalErrorAlert" class="alert alert-danger" style="display: none;"></div>
                <div id="modalSuccessAlert" class="alert alert-success" style="display: none;"></div>
                <input type="text" class="form-control" id="emailCodeInput" placeholder="Код подтверждения">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <!-- Добавленная кнопка для повторной отправки кода -->
                <button type="button" class="btn btn-warning" id="resendEmailCodeBtn">Отправить код повторно</button>
                <button type="button" class="btn btn-primary" id="confirmEmailChangeBtn">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentUser = null;
    let confirmationModal = null;
    let currentPendingEmail = null; // Добавлена переменная для хранения новой почты

    document.addEventListener('DOMContentLoaded', async function() {
        confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        await loadUserProfile();
        document.getElementById('profileForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('confirmEmailChangeBtn').addEventListener('click', handleConfirmEmailChange);
        // Добавлен обработчик для кнопки повторной отправки кода
        document.getElementById('resendEmailCodeBtn').addEventListener('click', handleResendEmailCode);
    });

    async function loadUserProfile() {
        try {
            const response = await fetch('/api/users/current');
            if (!response.ok) throw new Error('Ошибка загрузки профиля');
            currentUser = await response.json();
            document.getElementById('currentEmail').value = currentUser.email;
        } catch (error) {
            showError(error.message);
        }
    }

    async function handleFormSubmit(event) {
        event.preventDefault();

        const newEmail = document.getElementById('newEmail').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const currentPassword = document.getElementById('currentPassword').value;

        // 1. Если меняется пароль - отправляем запрос на смену пароля
        if (newPassword && currentPassword) {
            try {
                const response = await fetch('/api/users/password', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ newPassword, currentPassword })
                });
                const responseText = await response.text();
                if (!response.ok) throw new Error(responseText);
                showSuccess('Пароль успешно обновлен!');
                document.getElementById('newPassword').value = '';
                document.getElementById('currentPassword').value = '';
            } catch (error) {
                showError(error.message);
            }
        }

        // 2. Если меняется почта - отправляем запрос на подтверждение
        if (newEmail && newEmail !== currentUser.email) {
            try {
                currentPendingEmail = newEmail; // Сохраняем новую почту для повторной отправки
                const response = await fetch('/api/users/request-email-change', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: newEmail })
                });
                const responseText = await response.text();
                if (!response.ok) throw new Error(responseText);

                // Показываем модальное окно для ввода кода
                showSuccess(responseText);
                confirmationModal.show();
            } catch (error) {
                showError(error.message);
            }
        }
    }

    // 3. Обработка подтверждения из модального окна
    async function handleConfirmEmailChange() {
        const code = document.getElementById('emailCodeInput').value;
        if (!code) {
            showModalError('Введите код.');
            return;
        }

        try {
            const response = await fetch('/api/users/confirm-email-change', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code })
            });
            const responseText = await response.text();
            if (!response.ok) throw new Error(responseText);

            showSuccess('Почта успешно обновлена!');
            confirmationModal.hide();
            // Обновляем текущую почту на странице
            document.getElementById('currentEmail').value = document.getElementById('newEmail').value;
            document.getElementById('newEmail').value = '';
            document.getElementById('emailCodeInput').value = '';
            currentPendingEmail = null; // Сбрасываем сохраненную почту
            hideModalAlerts();
        } catch (error) {
            showModalError(error.message);
        }
    }

    // 4. Новый метод для повторной отправки кода
    async function handleResendEmailCode() {
        if (!currentPendingEmail) {
            showModalError('Нет активной почты для подтверждения.');
            return;
        }

        try {
            // Используем параметр запроса для передачи email
            const response = await fetch(`/api/users/resend-pendingEmail-code?pendingEmail=${encodeURIComponent(currentPendingEmail)}`, {
                method: 'POST'
            });
            const responseText = await response.text();
            if (!response.ok) throw new Error(responseText);

            showModalSuccess('Новый код подтверждения отправлен!');
        } catch (error) {
            showModalError(error.message);
        }
    }

    // Вспомогательные функции для показа алертов
    function showError(message) {
        const alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => { alert.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }

    // Функции для показа алертов в модальном окне
    function showModalError(message) {
        const alert = document.getElementById('modalErrorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => { alert.style.display = 'none'; }, 5000);
    }

    function showModalSuccess(message) {
        const alert = document.getElementById('modalSuccessAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }

    function hideModalAlerts() {
        document.getElementById('modalErrorAlert').style.display = 'none';
        document.getElementById('modalSuccessAlert').style.display = 'none';
    }
</script>
</body>
</html>